generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Unit {
  UN
  M2
  KG
}

enum StockMovementType {
  SELL
  ADJUST_IN
  ADJUST_OUT
  PRODUCTION
}

enum SupplierType {
  PJ
  PF
}

model User {
  id            String    @id @default(cuid())
  fullName      String
  email         String    @unique
  document      String?   @unique
  phone         String?
  password      String?
  role          Int?      @default(2)
  status        Int?      @default(3)
  activationKey String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  avatarURL     String?
  products      Product[]
  orders        Order[]
}

model Product {
  id               String   @id @default(cuid())
  name             String
  unit             Unit
  description      String?
  status           Int
  price            Decimal  @db.Decimal(14, 2)
  installmentPrice Decimal  @default(0) @db.Decimal(10, 2)
  stockOnHand      Decimal  @default(0) @db.Decimal(14, 4)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User?             @relation(fields: [userId], references: [id])
  userId           String?
  productionOrders ProductionOrder[]
  orderItems       OrderItem[]
}

model Client {
  id       String       @id @default(cuid())
  type     SupplierType @default(PF)
  name     String
  document String       @unique
  email    String?      @unique
  phone    String?
  status   Int          @default(1)
  ie       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  address Address?
  orders  Order[]
}

model Address {
  id           String  @id @default(cuid())
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  zipCode      String

  clientId String? @unique
  client   Client? @relation(fields: [clientId], references: [id])
}

enum ProductionStatus {
  DRAFT
  PENDING // Ordem Realizada
  IN_PRODUCTION // Em Fabricação
  CONFERENCE // Conferência
  COMPLETED // Pronto (Gera Estoque)
  CANCELLED // Cancelada (Não gera estoque, encerra o fluxo)
}

model ProductionOrder {
  id   String @id @default(uuid())
  code Int    @default(autoincrement())

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  deadline DateTime

  status ProductionStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum OrderStatus {
  DRAFT // Orçamento
  CONFIRMED // Pedido Confirmado (Estoque baixado/reservado)
  SHIPMENT // Em Entrega (Parcialmente entregue)
  DONE // Concluído (Tudo entregue)
  CANCELLED // Cancelado
}

model Order {
  id   String @id @default(uuid())
  code Int    @default(autoincrement()) // Código amigável (#1001)

  // Relacionamentos
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Se você tiver autenticação, descomente as linhas abaixo
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Dados Financeiros e Logísticos
  status        OrderStatus @default(DRAFT)
  totalItems    Decimal     @db.Decimal(10, 2) // Soma dos produtos
  shippingCost  Decimal     @default(0) @db.Decimal(10, 2) // Frete
  totalDiscount Decimal     @default(0) @db.Decimal(10, 2) // Desconto
  finalTotal    Decimal     @db.Decimal(10, 2) // Valor final a pagar

  // Dados de Entrega e Obs
  address     String? @db.Text // Endereço completo (opcional)
  observation String? @db.Text

  shipments OrderShipment[]
  items     OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("orders")
}

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity          Int
  deliveredQuantity Int @default(0)

  price    Decimal @db.Decimal(10, 2) // Preço no momento da venda (histórico)
  subtotal Decimal @db.Decimal(10, 2) // quantity * price

  @@map("order_items")
}

model OrderShipment {
  id   String @id @default(uuid())
  code Int    @default(autoincrement()) // Romaneio #201

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  driverName String? // Nome do motorista ou "Retirada Balcão"
  shippedAt  DateTime @default(now()) // Data da saída

  items OrderShipmentItem[]

  @@map("order_shipments")
}

model OrderShipmentItem {
  id String @id @default(uuid())

  shipmentId String
  shipment   OrderShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  orderItemId String
  productId   String
  quantity    Int

  @@map("order_shipment_items")
}
